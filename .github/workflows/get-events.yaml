name: 🖐 Grab Events

on: 
    workflow_dispatch:

permissions: write-all

defaults:
    run:
        shell: bash

jobs:
    fetch-events:
        runs-on: ubuntu-latest
        if: ${{ github.event_name == 'workflow_dispatch' }}
        outputs:
            new_ones: ${{ steps.save-data.outputs.new_ones }}
            new_list: ${{ steps.save-data.outputs.new_list }}
        steps:
        -   name: Checkout
            uses: actions/checkout@v4
            with:
                submodules: recursive
                fetch-depth: 0
        -   name: Fetch Data
            id: fetch-data
            uses: jroehl/gsheet.action@release
            with:
                spreadsheetId: 1XEmNv7bX9_VxxqzD7XhWayRs9dv1ZAHyns2W2UyIAtk
                commands: |
                            [
                                { "command": "getData", "args": { "range": "'Form Responses 1'!A1:I99", "hasHeaderRow": true }}
                            ]
            env:
                GSHEET_CLIENT_EMAIL: ${{ secrets.GSHEET_CLIENT_EMAIL }}
                GSHEET_PRIVATE_KEY: ${{ secrets.GSHEET_PRIVATE_KEY }}
        -   name: Save Data
            id: save-data
            env:
                RESULTS: ${{ steps.fetch-data.outputs.results }}
            run: |
                    git pull
                    data_file="data/events.json"
                    mkdir -p data
                    test -f $data_file || touch $data_file
                    existing=$(echo $(cat $data_file))
                    incoming=$(echo $RESULTS | jq)
                    incoming=$(echo $incoming | jq -r '.results[0].result.rawData' )
                    if [ -z "$existing" ]; then
                        allowed=$incoming
                        combined=$incoming
                    else
                        existslist=$(echo $existing | jq -c '[ .[] | .[0] ]')
                        allowed=$(echo $incoming | jq --argjson ex $existslist -r 'map(select(.[0] | . as $in | all($ex[]; . != $in)))')
                        combined=$(echo $existing $allowed | jq -s add)
                    fi
                    new_list=$(echo $allowed | jq -r 'map(.[0])')
                    echo 'new_list'=$new_list >> $GITHUB_OUTPUT
                    echo 'new_ones'=$allowed >> $GITHUB_OUTPUT
                    echo $combined > $data_file
        -   name: Commit Change
            id: commit-change
            run: |
                    git config --global user.name "GitHub Actions"
                    git config --global user.email "no-reply@github.com"
                    git tag updated-event-list
                    git add data/events.json
                    git commit -m "Updated event list"
                    git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
                    git push --follow-tags
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    build:
        uses: ./.github/workflows/hugo-build.yaml
        needs: fetch-events

    share:
        runs-on: ubuntu-latest
        needs: fetch-events
        if: ${{ needs.fetch-events.outputs.new_list != null }}
        strategy:
            matrix:
                steps: ${{ fromJSON(needs.fetch-events.outputs.new_list) }}
        steps:
            -   name: get new one
                id: get-new-one 
                run: |
                        new_one=$(echo '${{ needs.fetch-events.outputs.new_ones }}' | jq --arg step ${{ matrix.steps }} -r 'map(select(.[0] == $step))')
                        embeds=$(echo $new_one | jq -r '.[0] | { "title": .[2], "timestamp": .[3], "description": ("Where: " + .[4] + "\n" + .[6]) }')
                        if [ ! -z $(echo $new_one | jq -r '.[0][5]') ]; then
                            embeds=$(echo $embeds | jq --arg value $(echo $new_one | jq -r '.[0][5]') '. + { "url": ("https://www.meetup.com/st-louis-game-developers/events/" + $value) }')
                        fi
                        echo $embeds
                        echo embeds=$embeds >> $GITHUB_ENV
            -   name: STL Game Dev Discord
                uses: Ilshidur/action-discord@master
                env:
                    DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
                    DISCORD_EMBEDS: ${{ steps.get-new-one.outputs.embeds }}
                with:
                    args: ":calendar: A new event has been scheduled!"
                            
            

                        




                        

